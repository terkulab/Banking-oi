<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Banking App</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background:#f0f2f5;min-height:100vh;}
#loginSection{display:flex;justify-content:center;align-items:center;height:100vh;}
.login-box{background:#fff;padding:40px;border-radius:12px;box-shadow:0 15px 40px rgba(0,0,0,0.15);width:100%;max-width:400px;text-align:center;}
.login-box input, .login-box button{width:100%;padding:12px;margin:12px 0;border-radius:8px;border:1px solid #ccc;}
.login-box button{background:#0A2540;color:#fff;font-weight:600;border:none;cursor:pointer;}
.login-box h2{color:#0A2540;margin-bottom:20px;}
#dashboardSection{display:none;}
.sidebar{position:fixed;top:0;left:0;height:100%;width:250px;background:#0A2540;color:#fff;padding:20px;transition:all 0.3s ease;}
.sidebar h3{margin-bottom:20px;}
.sidebar button{width:100%;padding:12px;margin:6px 0;border:none;border-radius:8px;background:#1b3b70;color:#fff;cursor:pointer;}
.main-content{margin-left:260px;padding:20px;transition:all 0.3s ease;}
.card{background:#fff;padding:20px;margin:10px 0;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.1);}
.card h3{color:#0A2540;margin-bottom:12px;}
.flex button{margin-right:10px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:12px;border:1px solid #ccc;text-align:left;}
th{background:#0A2540;color:#fff;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.modal-content{background:#fff;padding:30px;border-radius:12px;width:90%;max-width:400px;position:relative;}
.modal-content input, .modal-content button{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ccc;}
.modal-content button{background:#0A2540;color:#fff;font-weight:600;border:none;cursor:pointer;}
.modal .close{position:absolute;top:10px;right:10px;background:red;color:#fff;padding:5px 10px;border:none;border-radius:50%;cursor:pointer;}
@media(max-width:768px){.sidebar{width:200px;position:fixed;left:-220px;}.main-content{margin-left:0;}.sidebar.active{left:0;}}
</style>
</head>
<body>

<section id="loginSection">
  <div class="login-box">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>
</section>

<section id="dashboardSection">
  <div class="sidebar" id="sidebar">
    <h3>Menu</h3>
    <button id="dashboardBtn">Dashboard</button>
    <button id="kycBtn">KYC Info</button>
    <button id="historyBtn">History</button>
    <button id="logoutBtn">Logout</button>
  </div>
  <div class="main-content" id="mainContent">
    <div id="dashboardContent" class="card">
      <h3>User Dashboard</h3>
      <p><b>Name:</b> <span id="userName"></span></p>
      <p><b>Balance:</b> $<span id="userBalance"></span></p>
      <p><b>Account Number:</b> <span id="userAccount"></span></p>
      <div class="flex">
        <button id="depositBtn">Deposit</button>
        <button id="transferBtn">Transfer</button>
        <button id="withdrawBtn">Withdraw</button>
      </div>
    </div>

    <div id="kycContent" class="card" style="display:none;">
      <h3>KYC Information</h3>
      <p><b>Name:</b> <span id="kycName"></span></p>
      <p><b>Email:</b> <span id="kycEmail"></span></p>
      <p><b>Account Number:</b> <span id="kycAccount"></span></p>
      <p><b>KYC Status:</b> <span id="kycStatus"></span></p>
    </div>

    <div id="historyContent" class="card" style="display:none;">
      <h3>Transaction History</h3>
      <div id="historyList">No transactions yet</div>
    </div>

    <div id="adminContent" class="card" style="display:none;">
      <h3>Admin Panel - Add User</h3>
      <input type="text" id="addUserName" placeholder="Name">
      <input type="email" id="addUserEmail" placeholder="Email">
      <input type="password" id="addUserPass" placeholder="Password">
      <input type="text" id="addUserAccount" placeholder="Account Number">
      <input type="number" id="addUserBalance" placeholder="Initial Balance">
      <input type="text" id="addUserAddress" placeholder="Payment Address">
      <button id="addUserBtn">Add User</button>

      <h3>Pending Transactions</h3>
      <table>
        <thead><tr><th>User ID</th><th>Type</th><th>Amount</th><th>Address</th><th>Action</th></tr></thead>
        <tbody id="pendingTable"></tbody>
      </table>
    </div>
  </div>
</section>

<div class="modal" id="modal">
  <div class="modal-content">
    <button class="close" id="modalClose">X</button>
    <h3 id="modalTitle">Action</h3>
    <input type="number" id="modalAmount" placeholder="Enter amount">
    <input type="text" id="modalAddress" placeholder="Payment Address (for Transfer/Withdrawal)">
    <button id="modalConfirm">Confirm</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {  
  apiKey: "AIzaSyCpGwKbyOW_LQPrTKoNvDjW_oTD9_cxsnc",  
  authDomain: "n26-bank-888bc.firebaseapp.com",  
  projectId: "n26-bank-888bc",  
  storageBucket: "n26-bank-888bc.appspot.com",  
  messagingSenderId: "112126821080",  
  appId: "1:112126821080:web:e455b16ffc29164d290dad"  
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;
const adminUser = {email:"admin@bankapp.com",password:"Admin1234!",uid:"admin123",name:"Admin User",role:"admin"};

const loginSection=document.getElementById('loginSection');
const dashboardSection=document.getElementById('dashboardSection');
const emailInput=document.getElementById('email');
const passwordInput=document.getElementById('password');
const loginBtn=document.getElementById('loginBtn');

const dashboardContent=document.getElementById('dashboardContent');
const kycContent=document.getElementById('kycContent');
const historyContent=document.getElementById('historyContent');
const adminContent=document.getElementById('adminContent');

const userNameEl=document.getElementById('userName');
const userBalanceEl=document.getElementById('userBalance');
const userAccountEl=document.getElementById('userAccount');

const kycNameEl=document.getElementById('kycName');
const kycEmailEl=document.getElementById('kycEmail');
const kycAccountEl=document.getElementById('kycAccount');
const kycStatusEl=document.getElementById('kycStatus');

const logoutBtn=document.getElementById('logoutBtn');
const depositBtn=document.getElementById('depositBtn');
const transferBtn=document.getElementById('transferBtn');
const withdrawBtn=document.getElementById('withdrawBtn');

const dashboardBtn=document.getElementById('dashboardBtn');
const kycBtn=document.getElementById('kycBtn');
const historyBtn=document.getElementById('historyBtn');

const modal=document.getElementById('modal');
const modalClose=document.getElementById('modalClose');
const modalTitle=document.getElementById('modalTitle');
const modalAmount=document.getElementById('modalAmount');
const modalAddress=document.getElementById('modalAddress');
const modalConfirm=document.getElementById('modalConfirm');

const addUserBtn=document.getElementById('addUserBtn');
const pendingTable=document.getElementById('pendingTable');

loginBtn.onclick=async()=>{
  const email=emailInput.value.trim();
  const password=passwordInput.value.trim();
  if(!email||!password){alert("Enter email & password");return;}

  if(email===adminUser.email && password===adminUser.password){
    currentUser=adminUser;
    loginSection.style.display="none";
    dashboardSection.style.display="block";
    adminContent.style.display="block";
    dashboardContent.style.display="none";
    loadPendingTransactions();
    return;
  }

  try{
    const userCred = await signInWithEmailAndPassword(auth,email,password);
    const snap = await getDoc(doc(db,"users",userCred.user.uid));
    if(!snap.exists()){alert("User not found");return;}
    const data=snap.data();
    currentUser={uid:userCred.user.uid,...data};
    loginSection.style.display="none";
    dashboardSection.style.display="block";

    if(data.role==="admin"){
      adminContent.style.display="block";
      dashboardContent.style.display="none";
      loadPendingTransactions();
    }else{
      dashboardContent.style.display="block";
      adminContent.style.display="none";
      loadUserDashboard();
      loadHistory();
    }
  }catch(e){alert("Login failed: "+e.message);}
};

logoutBtn.onclick=()=>{
  currentUser=null;
  dashboardSection.style.display="none";
  loginSection.style.display="flex";
  emailInput.value=''; passwordInput.value='';
};

dashboardBtn.onclick=()=>{dashboardContent.style.display="block";kycContent.style.display="none";historyContent.style.display="none";}
kycBtn.onclick=()=>{dashboardContent.style.display="none";kycContent.style.display="block";historyContent.style.display="none";}
historyBtn.onclick=()=>{dashboardContent.style.display="none";kycContent.style.display="none";historyContent.style.display="block";}

async function loadUserDashboard(){
  userNameEl.innerText=currentUser.name;
  userBalanceEl.innerText=currentUser.balance;
  userAccountEl.innerText=currentUser.accountNumber||"-";

  kycNameEl.innerText=currentUser.name;
  kycEmailEl.innerText=currentUser.email;
  kycAccountEl.innerText=currentUser.accountNumber||"-";
  kycStatusEl.innerText=currentUser.KYC||"Not uploaded";

  depositBtn.onclick=()=>{openModal("Deposit")};
  transferBtn.onclick=()=>{openModal("Transfer")};
  withdrawBtn.onclick=()=>{openModal("Withdraw")};
}

function openModal(type){
  modalTitle.innerText=type;
  modalAmount.value="";
  modalAddress.value="";
  modal.style.display="flex";

  modalConfirm.onclick = async ()=>{
    let amt=parseFloat(modalAmount.value);
    let addr=modalAddress.value.trim();
    if(isNaN(amt)||amt<=0){alert("Invalid amount");return;}
    let status=(type==="Deposit")?"approved":"pending";

    if(type==="Deposit"){
      currentUser.balance+=amt;
      await updateDoc(doc(db,"users",currentUser.uid),{balance:currentUser.balance});
      userBalanceEl.innerText=currentUser.balance;
    }

    await addDoc(collection(db,"transactions"),{
      userId:currentUser.uid,
      type:type,
      amount:amt,
      address:addr||null,
      status:status,
      timestamp:serverTimestamp()
    });

    if(type!=="Deposit"){alert(`${type} request is pending admin approval`);}
    else{alert("Deposit successful!");}

    modal.style.display="none";
    loadHistory();
  };
}
modalClose.onclick=()=>{modal.style.display="none";};

async function loadHistory(){
  historyContent.innerHTML=`<h3>Transaction History</h3>`;
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr>
    <th>Type</th><th>Amount</th><th>Address</th><th>Status</th><th>Date</th>
  </tr></thead>`;
  const tbody=document.createElement('tbody');

  const snap = await getDocs(collection(db,"transactions"));
  snap.forEach(d=>{
    const t=d.data();
    if(t.userId===currentUser.uid){
      const row=document.createElement('tr');
      row.innerHTML=`<td>${t.type}</td>
                     <td>$${t.amount}</td>
                     <td>${t.address||'-'}</td>
                     <td>${t.status}</td>
                     <td>${t.timestamp?.toDate().toLocaleString()||'Pending'}</td>`;
      tbody.appendChild(row);
    }
  });
  table.appendChild(tbody);
  historyContent.appendChild(table);
}

addUserBtn.onclick=async()=>{
  const name=document.getElementById('addUserName').value.trim();
  const email=document.getElementById('addUserEmail').value.trim();
  const pass=document.getElementById('addUserPass').value.trim();
  const account=document.getElementById('addUserAccount').value.trim();
  const balance=parseFloat(document.getElementById('addUserBalance').value.trim()||0);
  const address=document.getElementById('addUserAddress').value.trim();
  if(!name||!email||!pass){alert("Fill all fields");return;}
  try{
    const userCred=await createUserWithEmailAndPassword(auth,email,pass);
    await setDoc(doc(db,"users",userCred.user.uid),{
      name,email,role:"user",balance,accountNumber:account,paymentAddress:address,KYC:"Not uploaded"
    });
    alert("User added successfully!");
  }catch(e){alert("Failed: "+e.message);}
};

async function loadPendingTransactions(){
  pendingTable.innerHTML="";
  const snap=await getDocs(collection(db,"transactions"));
  snap.forEach(d=>{
    const t=d.data();
    if(t.status==="pending"){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.userId}</td>
                     <td>${t.type}</td>
                     <td>$${t.amount}</td>
                     <td>${t.address||'-'}</td>
                     <td>
                      <button onclick="approveTransaction('${d.id}',${t.amount},'${t.userId}')">Approve</button>
                      <button onclick="rejectTransaction('${d.id}')">Reject</button>
                     </td>`;
      pendingTable.appendChild(tr);
    }
  });
}

window.approveTransaction=async(id,amt,uid)=>{
  await updateDoc(doc(db,"transactions",id),{status:"approved"});
  const userRef=doc(db,"users",uid);
  const snap=await getDoc(userRef);
  if(snap.exists()){
    const data=snap.data();
    await updateDoc(userRef,{balance:data.balance-amt});
  }
  loadPendingTransactions();
  alert("Transaction approved!");
}

window.rejectTransaction=async(id)=>{
  await updateDoc(doc(db,"transactions",id),{status:"rejected"});
  loadPendingTransactions();
  alert("Transaction rejected!");
}
</script>
</body>
</html>
