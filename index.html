
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>N26 Mobile Banking</title>
<style>
/* --- RESET & BASE --- */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Arial,sans-serif}
body{background:#f0f2f5;color:#111;overflow-x:hidden;transition:0.3s}
.hidden{display:none}
.card{background:#fff;padding:25px;margin-bottom:25px;border-radius:20px;box-shadow:0 10px 25px rgba(0,0,0,.08);transition:0.3s}
.card:hover{box-shadow:0 15px 35px rgba(0,0,0,.15)}
button{background:#0052cc;color:#fff;border:none;padding:12px;border-radius:12px;cursor:pointer;width:100%;font-weight:bold;transition:0.3s;font-size:16px}
button:hover{background:#003c99}
input,select,textarea{width:100%;padding:12px;margin:10px 0;border-radius:12px;border:1px solid #ccc;font-size:16px;transition:0.2s}
input:focus, select:focus, textarea:focus{border-color:#0052cc;outline:none}
.sidebar{position:fixed;top:0;left:-260px;width:260px;height:100%;background:#002d72;color:#fff;padding:25px;transition:.4s;z-index:100;overflow-y:auto;}
.sidebar.show{left:0}
.sidebar a{display:flex;align-items:center;color:#fff;padding:15px;margin-bottom:12px;border-radius:15px;text-decoration:none;font-weight:bold;cursor:pointer;transition:0.3s}
.sidebar a:hover{background:rgba(255,255,255,0.1)}
.sidebar a span{margin-left:10px}
.header{background:linear-gradient(90deg,#0052cc,#002d72);color:#fff;padding:18px 25px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50;border-bottom-left-radius:20px;border-bottom-right-radius:20px;box-shadow:0 5px 15px rgba(0,0,0,0.1)}
.profile-img{width:120px;height:120px;border-radius:50%;object-fit:cover;margin-bottom:15px;border:4px solid #0052cc;transition:0.3s}
.profile-img:hover{transform:scale(1.05)}
.small{font-size:13px;color:#666}
h2,h3,h4{margin-bottom:12px;font-weight:600}
#overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);display:none;z-index:50;transition:0.3s}
table{width:100%;border-collapse:collapse;margin-top:15px;transition:0.3s}
table, th, td{border:1px solid #ccc}
th,td{padding:12px;text-align:center}
th{background:#0052cc;color:#fff}
tr:hover{background:#f1f5f9}
.approved{color:green;font-weight:bold}
.rejected{color:red;font-weight:bold}
.pending{color:orange;font-weight:bold}
@media(max-width:768px){.header{border-radius:0} .sidebar{width:220px}}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="card" style="max-width:380px;margin:120px auto;text-align:center;">
    <h2>üîê Login</h2>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="loginMsg" style="color:red;margin-top:10px"></p>
  </div>
</div>

<!-- Overlay -->
<div id="overlay" onclick="toggleSidebar()"></div>

<!-- BANK APP -->
<div id="bankApp" class="hidden">

  <!-- Header -->
  <div id="header" class="header">
    <span onclick="toggleSidebar()" style="cursor:pointer;font-size:22px;">‚ò∞</span>
    <span id="welcomeUser" style="font-weight:bold"></span>
  </div>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <h3 style="margin-bottom:20px;">N26 Bank</h3>
    <a onclick="showPage('dashboard')">üè¶ <span>Dashboard</span></a>
    <a onclick="showPage('kyc')">ü™™ <span>KYC</span></a>
    <a onclick="showPage('history')">üìú <span>Transaction History</span></a>
    <a id="adminLink" onclick="adminLoginPrompt()">üõ†Ô∏è <span>Admin Panel</span></a>
    <a onclick="logout()">üö™ <span>Logout</span></a>
  </div>

  <!-- Pages -->
  <div id="pagesContainer">

    <!-- Dashboard -->
    <div id="dashboard" class="page hidden">
      <div class="card" style="text-align:center;">
        <img id="profilePic" src="" class="profile-img" alt="Profile">
        <h3 id="userName"></h3>
        <p>Account #: <span id="accountNumber"></span></p>
        <h2>Balance: $<span id="balance"></span></h2>
      </div>
      <div class="card">
        <h3>Deposit / Withdraw</h3>
        <input id="amt" type="number" placeholder="Amount">
        <select id="txnType"><option value="Deposit">Deposit</option><option value="Withdraw">Withdraw</option></select>
        <button onclick="requestTransaction()">Place Transaction</button>
        <p class="small">Transactions are recorded immediately and withdrawals are pending admin approval.</p>
      </div>
    </div>

    <!-- KYC -->
    <div id="kyc" class="page hidden">
      <div class="card">
        <h3>KYC Verification</h3>
        <input id="kycName" placeholder="Full Name">
        <input id="kycAccount" placeholder="Account Number">
        <input id="kycAddress" placeholder="Address">
        <input type="file" id="kycPhoto">
        <button id="kycSubmitBtn" onclick="submitKYC()">Submit KYC</button>
      </div>
    </div>

    <!-- Transaction History -->
    <div id="history" class="page hidden">
      <div class="card">
        <h3>Transaction History</h3>
        <div id="txList"></div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin" class="page hidden">
      <div class="card">
        <h3>Admin Panel - Manage Users</h3>
        <input id="newUser" placeholder="Username">
        <input id="newPass" placeholder="Password">
        <button onclick="createUser()">Create User</button>
        <input id="fundUser" placeholder="Username to Fund">
        <input id="fundAmt" type="number" placeholder="Amount to Add">
        <button onclick="fundUserBalance()">Fund User</button>
      </div>
      <div class="card">
        <h4>All Users & Pending Transactions</h4>
        <table id="adminTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Password</th>
              <th>Balance</th>
              <th>Transactions</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCpGwKbyOW_LQPrTKoNvDjW_oTD9_cxsnc",
  authDomain: "n26-bank-888bc.firebaseapp.com",
  projectId: "n26-bank-888bc",
  storageBucket: "n26-bank-888bc.firebasestorage.app",
  messagingSenderId: "112126821080",
  appId: "1:112126821080:web:c108cc61d84a25f5290dad"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let currentUser = null;

// Initialize Admin
async function initAdmin(){
  const adminRef = doc(db,"users","admin");
  const adminSnap = await getDoc(adminRef);
  if(!adminSnap.exists()){
    await setDoc(adminRef,{
      password:"Admin1234!",
      role:"admin",
      balance:0,
      name:"Admin",
      account:"000001",
      photo:"",
      address:"",
      history:[]
    });
  }
}
initAdmin();

// --------- LOGIN WITH CACHE ---------
async function login() {
  const loginMsg = document.getElementById("loginMsg");
  loginMsg.style.color = "black";
  loginMsg.innerText = "Logging in...";

  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value.trim();

  // Check localStorage first
  const cached = localStorage.getItem(`user_${username}`);
  if (cached) {
    const data = JSON.parse(cached);
    if (data.password === password) {
      currentUser = username;
      document.getElementById("loginPage").style.display = "none";
      initBankApp();
      loginMsg.innerText = "";
      return;
    } else {
      loginMsg.style.color = "red";
      loginMsg.innerText = "Invalid password";
      return;
    }
  }

  // Fetch from Firestore if not cached
  const userRef = doc(db, "users", username);
  const userSnap = await getDoc(userRef);
  if (userSnap.exists()) {
    const data = userSnap.data();
    if (data.password === password) {
      currentUser = username;
      document.getElementById("loginPage").style.display = "none";
      initBankApp();
      loginMsg.innerText = "";
      localStorage.setItem(`user_${username}`, JSON.stringify(data));
    } else {
      loginMsg.style.color = "red";
      loginMsg.innerText = "Invalid password";
    }
  } else {
    loginMsg.style.color = "red";
    loginMsg.innerText = "User not found";
  }
}

// Update cache
function updateLocalCache(user,data){
  localStorage.setItem(`user_${user}`, JSON.stringify(data));
}

// --------- BANK APP ---------
async function initBankApp(){
  const data=(await getDoc(doc(db,"users",currentUser))).data();
  document.getElementById("bankApp").classList.remove("hidden");
  document.getElementById("welcomeUser").innerText="Welcome, "+currentUser;
  document.getElementById("profilePic").src=data.photo||"";
  document.getElementById("userName").innerText=data.name||currentUser;
  document.getElementById("balance").innerText=data.balance||0;
  document.getElementById("accountNumber").innerText=data.account||"N/A";

  document.getElementById("kycName").value=data.name||"";
  document.getElementById("kycAccount").value=data.account||"";
  document.getElementById("kycAddress").value=data.address||"";

  loadTransactions();
}

// Sidebar toggle
function toggleSidebar(){
  const sb=document.getElementById("sidebar");
  const ov=document.getElementById("overlay");
  sb.classList.toggle("show");
  ov.style.display=sb.classList.contains("show")?"block":"none";
}

// Show page
function showPage(pageId){
  document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
  document.getElementById(pageId).classList.remove("hidden");
  toggleSidebar();
}

// Logout
function logout(){location.reload();}

// --------- KYC ---------
async function submitKYC(){
  const name=document.getElementById("kycName").value.trim();
  const account=document.getElementById("kycAccount").value.trim();
  const address=document.getElementById("kycAddress").value.trim();
  const photoInput=document.getElementById("kycPhoto");
  let photo="";
  if(photoInput.files.length>0){
    const reader=new FileReader();
    reader.onload=async function(e){
      photo=e.target.result;
      await updateDoc(doc(db,"users",currentUser),{name,account,address,photo});
      updateLocalCache(currentUser,{...JSON.parse(localStorage.getItem(`user_${currentUser}`)),name,account,address,photo});
      alert("KYC Submitted Successfully");
      initBankApp();
    }
    reader.readAsDataURL(photoInput.files[0]);
  } else {
    await updateDoc(doc(db,"users",currentUser),{name,account,address});
    updateLocalCache(currentUser,{...JSON.parse(localStorage.getItem(`user_${currentUser}`)),name,account,address});
    alert("KYC Submitted Successfully");
    initBankApp();
  }
}

// --------- TRANSACTIONS ---------
async function requestTransaction(){
  const amt=parseFloat(document.getElementById("amt").value);
  const type=document.getElementById("txnType").value;
  if(!amt || amt<=0){alert("Enter valid amount"); return;}
  const userRef=doc(db,"users",currentUser);
  const data=(await getDoc(userRef)).data();
  const txn={type,amount:amt,status:type==="Deposit"?"Successful":"Pending (Contact Support)",date:new Date().toLocaleString()};
  const newBalance = type==="Deposit"?data.balance+amt:data.balance;
  await updateDoc(userRef,{history: arrayUnion(txn), balance: newBalance});
  updateLocalCache(currentUser,{...data,history:[...(data.history||[]),txn],balance:newBalance});
  alert(type+" Transaction Placed");
  loadTransactions();
}

async function loadTransactions(){
  const data=(await getDoc(doc(db,"users",currentUser))).data();
  const txList=document.getElementById("txList");
  txList.innerHTML="";
  if(data.history){
    data.history.forEach(tx=>{
      const p=document.createElement("p");
      p.innerHTML=`${tx.date} - ${tx.type} - $${tx.amount} - <span class="${tx.status.toLowerCase().includes("pending")?"pending":tx.status==="Successful"?"approved":"rejected"}">${tx.status}</span>`;
      txList.appendChild(p);
    });
  }
}

// --------- ADMIN ---------
async function adminLoginPrompt(){
  const user=prompt("Admin Username:");
  const pass=prompt("Admin Password:");
  if(user==="admin" && pass==="Admin1234!"){
    showPage("admin");
    loadAdminPanel();
  } else alert("Invalid Admin Login");
}

async function createUser(){
  const u=document.getElementById("newUser").value.trim();
  const p=document.getElementById("newPass").value.trim();
  if(!u||!p){alert("Enter username and password"); return;}
  const userRef=doc(db,"users",u);
  const userSnap=await getDoc(userRef);
  if(userSnap.exists()){alert("User already exists"); return;}
  await setDoc(userRef,{password:p,role:"user",balance:0,name:"",account:"",photo:"",address:"",history:[]});
  alert("User Created Successfully");
  document.getElementById("newUser").value="";
  document.getElementById("newPass").value="";
  loadAdminPanel();
}

async function fundUserBalance(){
  const u=document.getElementById("fundUser").value.trim();
  const amt=parseFloat(document.getElementById("fundAmt").value);
  if(!u||!amt){alert("Enter username and amount"); return;}
  const userRef=doc(db,"users",u);
  const userSnap=await getDoc(userRef);
  if(!userSnap.exists()){alert("User not found"); return;}
  const data=userSnap.data();
  const txn={type:"Deposit",amount:amt,status:"Successful",date:new Date().toLocaleString()};
  const newBalance=data.balance+amt;
  await updateDoc(userRef,{balance:newBalance,history: arrayUnion(txn)});
  updateLocalCache(u,{...data,history:[...(data.history||[]),txn],balance:newBalance});
  alert("User Funded Successfully");
  document.getElementById("fundUser").value="";
  document.getElementById("fundAmt").value="";
  loadAdminPanel();
}

async function loadAdminPanel(){
  const tbody=document.querySelector("#adminTable tbody");
  tbody.innerHTML="";
  const snapshot=await getDocs(collection(db,"users"));
  snapshot.forEach(docSnap=>{
    const d=docSnap.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${docSnap.id}</td><td>${d.password}</td><td>${d.balance}</td><td>${d.history.map(tx=>tx.type+" $"+tx.amount+" ("+tx.status+")").join("<br>")}</td>
    <td>${d.role!=="admin"?`<button onclick="approveTxn('${docSnap.id}')">Approve</button> <button onclick="rejectTxn('${docSnap.id}')">Reject</button>`:""}</td>`;
    tbody.appendChild(tr);
  });
}

async function approveTxn(user){
  const userRef=doc(db,"users",user);
  const data=(await getDoc(userRef)).data();
  let updated=false;
  const newHistory=data.history.map(tx=>{
    if(tx.status==="Pending (Contact Support)" && !updated){updated=true; return {...tx,status:"Successful"};} return tx;
  });
  await updateDoc(userRef,{history:newHistory});
  updateLocalCache(user,{...data,history:newHistory});
  loadAdminPanel();
  alert("Transaction Approved");
}

async function rejectTxn(user){
  const userRef=doc(db,"users",user);
  const data=(await getDoc(userRef)).data();
